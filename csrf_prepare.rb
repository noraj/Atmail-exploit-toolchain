#!/usr/bin/env ruby

require 'yaml'

# read config
config    = YAML.load_file('config.yml')['csrf']
csrf_file = 'csrf_plugin.js'

# load payload and convert to hex
data = File.read(config['filename']).unpack1('H*')
# create an escaped string
data = data.scan(/../).map { |x| "\\x#{x}" }.join

original_content = File.read(csrf_file)

edited_content = original_content.gsub(/var filename = '.*';/, "var filename = '#{config['filename']}';")
                   .gsub(/var protocol = '.*';/, "var protocol = '#{config['protocol']}';")
                   .gsub(/var host = '.*';/, "var host = '#{config['host']}';")
                   .gsub(/var root = '.*';/, "var root = '#{config['root']}';")
                   .gsub(/var data = '.*';/, "var data = '#{data}';")
                   .gsub(/var wait = [0-9]+;/, "var wait = #{config['wait']};")

File.open(csrf_file, 'w') do |file|
  file.puts edited_content
end
